// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

// generator nestjsDto {
//   provider                        = "prisma-generator-nestjs-dto"
//   output                          = "../src/dto/generated"
//   outputToNestJsResourceStructure = "true"
//   exportRelationModifierClasses   = "true"
//   reExport                        = "false"
//   createDtoPrefix                 = "Create"
//   updateDtoPrefix                 = "Update"
//   dtoSuffix                       = "Dto"
//   entityPrefix                    = ""
//   entitySuffix                    = ""
//   fileNamingStyle                 = "kebab"
// }

generator nestjsDto {
  provider                        = "prisma-generator-nestjs-dto"
  output                          = "../src/generated-dto"
  outputToNestJsResourceStructure = "true"
  flatResourceStructure           = "false"
  exportRelationModifierClasses   = "true"
  reExport                        = "false"
  createDtoPrefix                 = "Create"
  updateDtoPrefix                 = "Update"
  dtoSuffix                       = "Dto"
  entityPrefix                    = ""
  entitySuffix                    = ""
  classValidation                 = "false"
  fileNamingStyle                 = "kebab"
  noDependencies                  = "false"
  outputType                      = "class"
  prettier                        = "true"
}

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  user
  admin
  teacher
}

enum EssayStatus {
  draft
  public
  private
  deleted
}

enum AuthProvider {
  local
  google
  facebook
}

enum Language {
  ENGLISH
  JAPANESE
  KOREAN
  CHINESE
  VIETNAMESE
  FRENCH
  GERMAN
  SPANISH
}

enum ProficiencyLevel {
  BEGINNER
  ELEMENTARY
  INTERMEDIATE
  UPPER_INTERMEDIATE
  ADVANCED
  MASTER
}

enum SpaceTarget {
  GENERAL_LEARNING
  TEST_PREPARATION
  BUSINESS
  ACADEMIC
  CONVERSATION
  TRAVEL
  PROFESSIONAL
  ORTHER
}

model User {
  id              String           @id @default(uuid())
  username        String           @unique
  email           String           @unique
  passwordHash    String?          @map("password_hash")
  role            UserRole         @default(user)
  authProvider    AuthProvider     @default(local) @map("auth_provider")
  authProviderId  String?          @map("auth_provider_id")
  firstName       String?          @map("first_name")
  lastName        String?          @map("last_name")
  profilePicture  String?          @map("profile_picture")
  isEmailVerified Boolean          @default(false) @map("is_email_verified")
  currentLevel    ProficiencyLevel @default(BEGINNER) @map("current_level")

  /// Language settings for user
  /// @example
  /// [{
  ///   "language": "en",
  ///   "proficiency_level": "ADVANCED", // BEGINNER, INTERMEDIATE, ADVANCED, NATIVE
  ///   "is_native": false
  /// }]
  languages Json      @default("[]")
  lastLogin DateTime? @map("last_login")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relations
  courses           Course[]
  userCourses       UserCourse[]
  notes             Note[]
  vocabularies      Vocabulary[]
  spaces            Space[]
  essays            Essay[]
  corrections       Correction[]
  correctionReplies CorrectionReply[]

  @@map("users")
}

model Course {
  id            String           @id @default(uuid())
  currentUnitId String?          @map("current_unit_id")
  title         String
  description   String?
  thumbnailUrl  String?          @map("thumbnail_url")
  level         ProficiencyLevel
  price         Decimal
  totalWeight   Int              @default(0) @map("total_weight")
  isPublished   Boolean          @default(false) @map("is_published")

  /// Course reviews from users
  /// @example
  /// [{
  ///   "user_id": "uuid",
  ///   "rating": 5,
  ///   "comment": "Great course!",
  ///   "created_at": "2024-03-15T10:00:00Z"
  /// }]
  reviews   Json     @default("[]")
  createdBy String   @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  currentUnit Unit?         @relation("CurrentUnit", fields: [currentUnitId], references: [id])
  creator     User          @relation(fields: [createdBy], references: [id])
  units       Unit[]
  userCourses UserCourse[]
  spaces      SpaceCourse[]

  @@index([isPublished, level])
  @@map("courses")
}

model UserCourse {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  courseId      String   @map("course_id")
  paymentId     String?  @map("payment_id")
  paymentStatus String?  @default("pending") @map("payment_status")
  purchasePrice Decimal  @map("purchase_price") @db.Decimal(10, 2)
  purchasedAt   DateTime @default(now()) @map("purchased_at")

  // Relations
  user   User   @relation(fields: [userId], references: [id])
  course Course @relation(fields: [courseId], references: [id])

  @@unique([userId, courseId])
  @@index([paymentStatus])
  @@map("user_courses")
}

model Unit {
  id          String  @id @default(uuid())
  courseId    String  @map("course_id")
  title       String
  description String?
  orderIndex  Int     @map("order_index")

  /// Comments on the unit
  /// @example
  /// [{
  ///   "user_id": "uuid",
  ///   "content": "Great explanation!",
  ///   "created_at": "2024-03-15T10:00:00Z"
  /// }]
  comments  Json     @default("[]")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  course           Course        @relation(fields: [courseId], references: [id])
  contents         UnitContent[]
  notes            Note[]
  currentInCourses Course[]      @relation("CurrentUnit")

  @@map("units")
}

model UnitContent {
  id          String @id @default(uuid())
  unitId      String @map("unit_id")
  title       String
  contentType String @map("content_type")

  /// Content data from craftjs/tiptap editor
  /// Structure depends on content_type:
  /// - For 'theory': Editor content
  /// - For 'video': { url: string, duration: number }
  /// - For 'excercise': Editor content
  /// - For 'quiz': Array of questions/answers
  content        Json
  orderIndex     Int      @map("order_index")
  isPremium      Boolean  @default(false) @map("is_premium")
  isRequired     Boolean  @default(true) @map("is_required")
  completeWeight Int      @default(1) @map("complete_weight")
  isDone         Boolean  @default(false) @map("is_done")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  unit Unit @relation(fields: [unitId], references: [id])

  @@map("unit_contents")
}

model Note {
  id      String  @id @default(uuid())
  spaceId String? @map("space_id")
  unitId  String  @map("unit_id")
  title   String
  content String

  /// Tags for filtering notes
  /// @example
  /// ["grammar", "important", "review", "vocabulary"]
  tags         Json      @default("[]")
  isBookmarked Boolean   @default(false) @map("is_bookmarked")
  createdBy    String    @map("created_by")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")

  // Relations
  unit    Unit   @relation(fields: [unitId], references: [id])
  creator User   @relation(fields: [createdBy], references: [id])
  space   Space? @relation(fields: [spaceId], references: [id])

  @@map("notes")
}

model Vocabulary {
  id              String  @id @default(uuid())
  spaceId         String  @map("space_id")
  term            String
  meaning         String
  exampleSentence String? @map("example_sentence")
  imageUrl        String? @map("image_url")
  referenceLink   String? @map("reference_link")
  referenceName   String? @map("reference_name")

  /// Tags for categorizing vocabulary
  /// @example
  /// ["business", "common", "idiom", "phrasal-verb"]
  tags            Json      @default("[]")
  repetitionLevel Int       @default(0) @map("repetition_level")
  nextReview      DateTime? @map("next_review")
  createdBy       String    @map("created_by")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  space   Space @relation(fields: [spaceId], references: [id])
  creator User  @relation(fields: [createdBy], references: [id])

  @@index([term])
  @@map("vocabularies")
}

model Space {
  id          String      @id @default(uuid())
  name        String
  description String?
  target      SpaceTarget
  language    Language
  createdBy   String      @map("created_by")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // Relations
  creator      User          @relation(fields: [createdBy], references: [id])
  essays       Essay[]
  vocabularies Vocabulary[]
  notes        Note[]
  courses      SpaceCourse[]

  @@map("spaces")
}

model SpaceCourse {
  id       String   @id @default(uuid())
  spaceId  String   @map("space_id")
  courseId String   @map("course_id")
  joinedAt DateTime @default(now()) @map("joined_at")

  // Relations
  space  Space  @relation(fields: [spaceId], references: [id])
  course Course @relation(fields: [courseId], references: [id])

  @@unique([spaceId, courseId])
  @@map("space_courses")
}

model Essay {
  id          String      @id @default(uuid())
  spaceId     String      @map("space_id")
  title       String
  upvoteCount Int         @default(0) @map("upvote_count")
  summary     String?
  content     String
  coverUrl    String?     @map("cover_url")
  status      EssayStatus
  language    String
  createdBy   String      @map("created_by")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  deletedAt   DateTime?   @map("deleted_at")

  // Relations
  space       Space          @relation(fields: [spaceId], references: [id])
  author      User           @relation(fields: [createdBy], references: [id])
  hashtags    EssayHashtag[]
  corrections Correction[]

  @@index([status, language])
  @@map("essays")
}

model EssayHashtag {
  id        String   @id @default(uuid())
  essayId   String   @map("essay_id")
  hashtagId String   @map("hashtag_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  essay   Essay   @relation(fields: [essayId], references: [id])
  hashtag Hashtag @relation(fields: [hashtagId], references: [id])

  @@unique([essayId, hashtagId])
  @@map("essay_hashtags")
}

model Hashtag {
  id         String   @id @default(uuid())
  name       String   @unique
  usageCount Int      @default(0) @map("usage_count")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  essays EssayHashtag[]

  @@map("hashtags")
}

model Correction {
  id             String   @id @default(uuid())
  essayId        String   @map("essay_id")
  overallComment String?  @map("overall_comment")
  rating         Float?
  createdBy      String   @map("created_by")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  essay     Essay                @relation(fields: [essayId], references: [id])
  creator   User                 @relation(fields: [createdBy], references: [id])
  sentences CorrectionSentence[]
  replies   CorrectionReply[]

  @@map("corrections")
}

model CorrectionSentence {
  id            String   @id @default(uuid())
  correctionId  String   @map("correction_id")
  index         Int
  originalText  String   @map("original_text")
  correctedText String?  @map("corrected_text")
  explanation   String?
  isCorrect     Boolean  @default(false) @map("is_correct")
  rating        Float?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  correction Correction @relation(fields: [correctionId], references: [id])

  @@map("correction_sentences")
}

model CorrectionReply {
  id           String   @id @default(uuid())
  correctionId String   @map("correction_id")
  comment      String
  createdBy    String   @map("created_by")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  correction Correction @relation(fields: [correctionId], references: [id])
  creator    User       @relation(fields: [createdBy], references: [id])

  @@map("correction_replies")
}
